

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>dlmfg.core.core_model &mdash; Bayesian Deep Learning For Manufacturing (dlmfg) 2.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Bayesian Deep Learning For Manufacturing (dlmfg)
          

          
          </a>

          
            
            
              <div class="version">
                2.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation and Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../real_system_implementation.html">Real System Implementation (3D Optical Scanner: WLS400A)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../lib_config.html">Library Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_description.html">Data Description &amp; Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../model_arch.html">Model Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../drl.html">Deep Reinforcement Learning for Control and Correction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../model_selection.html">Model Architecture Selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bayes.html">Bayesian Deep Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../interpret.html">3D U-Net Architecture Global Interpretability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../interpret_local.html">3D U-Net Architecture Local Interpretability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../segment.html">3D U-Net Segmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../classes.html">Class Structure: Objects and Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kmc.html">Key Measurement Characteristics (KMCs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../utilities.html">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../transfer_learning.html">Continual and Transfer Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../active_learning.html">Active Learning/Adaptive Sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../viz.html">Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study_halo.html">Case Study: Positioning and Clamping Variations for Halo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study_inner_rf.html">Case Study: Door Inner and Hinge Reinforcement Multi-Stage Assembly</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cross_member.html">Case Study: Cross Member Multi-Station Assembly</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../refrences.html">Research and References</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Bayesian Deep Learning For Manufacturing (dlmfg)</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>dlmfg.core.core_model</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for dlmfg.core.core_model</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot; Contains core classes and methods for initializing the deep learning 3D CNN model with different variants of the loss function, inputs are provided from the modelconfig_train.py file&quot;&quot;&quot;</span>

<div class="viewcode-block" id="DLModel"><a class="viewcode-back" href="../../../deep_learning.html#dlmfg.core.core_model.DLModel">[docs]</a><span class="k">class</span> <span class="nc">DLModel</span><span class="p">:</span>	
	<span class="sd">&quot;&quot;&quot; Deep Learning Model Class</span>

<span class="sd">		:param model_type: Type of model to be used for training 3D CNN with MSE loss, 3D CNN with hetreoskedastic aleatoric loss, 3D CNN with a mixture density network (GMM) output</span>
<span class="sd">		:type model_type: str (required)</span>

<span class="sd">		:param output_dimension: Number of output nodes for the network equal to number of KCCs for the assembly in case MSE is used as loss function</span>
<span class="sd">		:type output_dimension: int (required)</span>

<span class="sd">		:param optimizer: The optimizer to be used while model training, refer: https://keras.io/optimizers/ for more information</span>
<span class="sd">		:type optimizer: keras.optimizer (required) </span>

<span class="sd">		:param loss_function: The loss function to be optimized by training the model, refer: https://keras.io/losses/ for more information</span>
<span class="sd">		:type loss_function: keras.losses (required)</span>

<span class="sd">		:param regularizer_coeff: The L2 norm regularization coefficient value used in the penultimate fully connected layer of the model, refer: https://keras.io/regularizers/ for more information</span>
<span class="sd">		:type regularizer_coeff: float (required)</span>

<span class="sd">		:param output_type: The output type of the model which can be regression or classification, this is used to define the output layer of the model, defaults to regression (classification: softmax, regression: linear)</span>
<span class="sd">		:type output_type: str		</span>

<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model_type</span><span class="p">,</span><span class="n">output_dimension</span><span class="p">,</span><span class="n">optimizer</span><span class="p">,</span><span class="n">loss_function</span><span class="p">,</span><span class="n">regularizer_coeff</span><span class="p">,</span><span class="n">output_type</span><span class="o">=</span><span class="s1">&#39;regression&#39;</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">output_dimension</span><span class="o">=</span><span class="n">output_dimension</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="o">=</span><span class="n">model_type</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">loss_function</span><span class="o">=</span><span class="n">loss_function</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">regularizer_coeff</span><span class="o">=</span><span class="n">regularizer_coeff</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">output_type</span><span class="o">=</span><span class="n">output_type</span>

<div class="viewcode-block" id="DLModel.cnn_model_3d"><a class="viewcode-back" href="../../../deep_learning.html#dlmfg.core.core_model.DLModel.cnn_model_3d">[docs]</a>	<span class="k">def</span> <span class="nf">cnn_model_3d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">voxel_dim</span><span class="p">,</span><span class="n">deviation_channels</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Build the 3D Model using the specified loss function, the inputs are parsed from the assemblyconfig_&lt;case_study_name&gt;.py file</span>

<span class="sd">			:param voxel_dim: The voxel dimension of the input, required to build input to the 3D CNN model</span>
<span class="sd">			:type voxel_dim: int (required)</span>

<span class="sd">			:param voxel_channels: The number of voxel channels in the input structure, required to build input to the 3D CNN model</span>
<span class="sd">			:type voxel_channels: int (required)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Conv3D</span><span class="p">,</span> <span class="n">MaxPool3D</span><span class="p">,</span> <span class="n">Flatten</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Dropout</span>
		<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>
		<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">regularizers</span>

		<span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_type</span><span class="o">==</span><span class="s2">&quot;regression&quot;</span><span class="p">):</span>
			<span class="n">final_layer_avt</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span>

		<span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_type</span><span class="o">==</span><span class="s2">&quot;classification&quot;</span><span class="p">):</span>
			<span class="n">final_layer_avt</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span>

		<span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
		<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv3D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span><span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">voxel_dim</span><span class="p">,</span><span class="n">voxel_dim</span><span class="p">,</span><span class="n">voxel_dim</span><span class="p">,</span><span class="n">deviation_channels</span><span class="p">)))</span>
		<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv3D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
		<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv3D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
		<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPool3D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
		<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Flatten</span><span class="p">())</span>
		<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regularizer_coeff</span><span class="p">),</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
		<span class="c1">#model.add(Dropout(0.2))</span>
		<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regularizer_coeff</span><span class="p">),</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
		<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dimension</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">final_layer_avt</span><span class="p">))</span>
		<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_function</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">])</span>

		<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;3D CNN model successfully compiled&quot;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">model</span></div>

	<span class="k">def</span> <span class="nf">resnet_3d_cnn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">voxel_dim</span><span class="p">,</span><span class="n">deviation_channels</span><span class="p">,</span><span class="n">w_val</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

		<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
		<span class="kn">import</span> <span class="nn">tensorflow.keras.backend</span> <span class="k">as</span> <span class="nn">K</span> 
		<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Model</span>
		<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">regularizers</span>
		<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Conv3D</span><span class="p">,</span> <span class="n">MaxPooling3D</span><span class="p">,</span> <span class="n">Add</span><span class="p">,</span> <span class="n">BatchNormalization</span><span class="p">,</span> <span class="n">Input</span><span class="p">,</span> <span class="n">LeakyReLU</span><span class="p">,</span><span class="n">Activation</span><span class="p">,</span> <span class="n">Lambda</span><span class="p">,</span> <span class="n">Concatenate</span><span class="p">,</span> <span class="n">Flatten</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span><span class="n">UpSampling3D</span><span class="p">,</span><span class="n">GlobalAveragePooling3D</span>

		<span class="k">if</span><span class="p">(</span><span class="n">w_val</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
			<span class="n">w_val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dimension</span><span class="p">)</span>
			<span class="n">w_val</span><span class="p">[:]</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dimension</span>


		<span class="k">def</span> <span class="nf">weighted_mse</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
			<span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="n">yTrue</span><span class="p">,</span><span class="n">yPred</span><span class="p">):</span>

				<span class="c1">#val = np.array([0.1,0.1,0.1,0.1,0.1]) </span>
				<span class="n">w_var</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> 
											 <span class="n">name</span><span class="o">=</span><span class="s1">&#39;weight_vec&#39;</span><span class="p">)</span>
				<span class="c1">#weight_vec = K.ones_like(yTrue[0,:]) #a simple vector with ones shaped as (60,)</span>
				<span class="c1">#idx = K.cumsum(ones) #similar to a &#39;range(1,61)&#39;</span>

				<span class="k">return</span> <span class="n">K</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">w_var</span><span class="p">)</span><span class="o">*</span><span class="n">K</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">yTrue</span><span class="o">-</span><span class="n">yPred</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">loss</span>

		<span class="n">input_size</span><span class="o">=</span><span class="p">(</span><span class="n">voxel_dim</span><span class="p">,</span><span class="n">voxel_dim</span><span class="p">,</span><span class="n">voxel_dim</span><span class="p">,</span><span class="n">deviation_channels</span><span class="p">)</span>
		<span class="n">inputs</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">input_size</span><span class="p">)</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">Conv3D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;conv_block_1&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
		<span class="n">res1</span><span class="o">=</span><span class="n">y</span>
		
		<span class="n">y</span> <span class="o">=</span> <span class="n">LeakyReLU</span><span class="p">()(</span><span class="n">y</span><span class="p">)</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">Conv3D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;conv_block_2&quot;</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">LeakyReLU</span><span class="p">()(</span><span class="n">y</span><span class="p">)</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">Conv3D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;conv_block_3&quot;</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">Add</span><span class="p">()([</span><span class="n">res1</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">LeakyReLU</span><span class="p">()(</span><span class="n">y</span><span class="p">)</span>
		
		<span class="n">y</span> <span class="o">=</span> <span class="n">Conv3D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;conv_block_4&quot;</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>
		<span class="n">res2</span><span class="o">=</span><span class="n">y</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">LeakyReLU</span><span class="p">()(</span><span class="n">y</span><span class="p">)</span>
		
		<span class="n">y</span> <span class="o">=</span> <span class="n">Conv3D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;conv_block_5&quot;</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">LeakyReLU</span><span class="p">()(</span><span class="n">y</span><span class="p">)</span>
		
		<span class="n">y</span> <span class="o">=</span> <span class="n">Conv3D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;conv_block_6&quot;</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">Add</span><span class="p">()([</span><span class="n">res2</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">LeakyReLU</span><span class="p">()(</span><span class="n">y</span><span class="p">)</span>
		
		<span class="n">y</span> <span class="o">=</span> <span class="n">Conv3D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;conv_block_7&quot;</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>
		<span class="n">res3</span><span class="o">=</span><span class="n">y</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">LeakyReLU</span><span class="p">()(</span><span class="n">y</span><span class="p">)</span>
		
		<span class="n">y</span> <span class="o">=</span> <span class="n">Conv3D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;conv_block_8&quot;</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">LeakyReLU</span><span class="p">()(</span><span class="n">y</span><span class="p">)</span>
		
		<span class="n">y</span> <span class="o">=</span> <span class="n">Conv3D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;conv_block_9&quot;</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>
		
		<span class="n">y</span> <span class="o">=</span> <span class="n">Add</span><span class="p">()([</span><span class="n">res3</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">LeakyReLU</span><span class="p">()(</span><span class="n">y</span><span class="p">)</span>
		
		<span class="n">y</span><span class="o">=</span><span class="n">Flatten</span><span class="p">()(</span><span class="n">y</span><span class="p">)</span>
		
		<span class="n">y</span><span class="o">=</span><span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span><span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regularizer_coeff</span><span class="p">),</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>
		<span class="n">y</span><span class="o">=</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regularizer_coeff</span><span class="p">),</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>
		<span class="n">output</span><span class="o">=</span><span class="n">Dense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dimension</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>
		
		<span class="n">model</span><span class="o">=</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">output</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Res_3D_CNN&#39;</span><span class="p">)</span>
		
		<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_function</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">])</span>
		
		<span class="c1">#print(model.summary())</span>
		
		<span class="k">return</span> <span class="n">model</span>

	
		
<div class="viewcode-block" id="DLModel.cnn_model_3d_tl"><a class="viewcode-back" href="../../../deep_learning.html#dlmfg.core.core_model.DLModel.cnn_model_3d_tl">[docs]</a>	<span class="k">def</span> <span class="nf">cnn_model_3d_tl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">voxel_dim</span><span class="p">,</span><span class="n">deviation_channels</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Build the 3D Model with GlobalMAxPooling3D instead of flatten, this enables input for different voxel dimensions, to be used when the model needs to be leveraged for transfer learning with different size input</span>

<span class="sd">			:param voxel_dim: The voxel dimension of the input, required to build input to the 3D CNN model</span>
<span class="sd">			:type voxel_dim: int (required)</span>

<span class="sd">			:param voxel_channels: The number of voxel channels in the input structure, required to build input to the 3D CNN model</span>
<span class="sd">			:type voxel_channels: int (required)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Conv3D</span><span class="p">,</span> <span class="n">MaxPool3D</span><span class="p">,</span> <span class="n">Flatten</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Dropout</span><span class="p">,</span> <span class="n">Input</span>
		<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Model</span>
		<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">regularizers</span>

		<span class="n">inputs</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="mi">3</span><span class="p">,))</span>
		<span class="n">cnn3d_1</span><span class="o">=</span><span class="n">Conv3D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">inputs</span><span class="p">)</span>
		<span class="n">cnn3d_2</span><span class="o">=</span><span class="n">Conv3D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">cnn3d_1</span><span class="p">)</span>
		<span class="n">cnn3d_3</span><span class="o">=</span><span class="n">Conv3D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">cnn3d_2</span><span class="p">)</span>
		<span class="n">max_pool3d</span><span class="o">=</span><span class="n">MaxPool3D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))(</span><span class="n">cnn3d_3</span><span class="p">)</span>
		<span class="n">pooled_layer</span><span class="o">=</span><span class="n">GlobalMaxPooling3D</span><span class="p">()(</span><span class="n">max_pool3d</span><span class="p">)</span>
		<span class="n">dense_1</span><span class="o">=</span><span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span><span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regularizer_coeff</span><span class="p">),</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">pooled_layer</span><span class="p">)</span>
		<span class="n">predictions</span><span class="o">=</span><span class="n">Dense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dimension</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">final_layer_avt</span><span class="p">)(</span><span class="n">dense_1</span><span class="p">)</span>
		<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">predictions</span><span class="p">)</span>

		<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_function</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">])</span>
		
		<span class="k">return</span> <span class="n">model</span></div>

<div class="viewcode-block" id="DLModel.cnn_model_3d_aleatoric"><a class="viewcode-back" href="../../../deep_learning.html#dlmfg.core.core_model.DLModel.cnn_model_3d_aleatoric">[docs]</a>	<span class="k">def</span> <span class="nf">cnn_model_3d_aleatoric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">voxel_dim</span><span class="p">,</span><span class="n">deviation_channels</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Build the 3D Model with a heteroeskedastic aleatoric loss, this enables different standard deviation of each predicted value, to be used when the expected sensor noise is heteroskedastic</span>

<span class="sd">			:param voxel_dim: The voxel dimension of the input, required to build input to the 3D CNN model</span>
<span class="sd">			:type voxel_dim: int (required)</span>

<span class="sd">			:param voxel_channels: The number of voxel channels in the input structure, required to build input to the 3D CNN model</span>
<span class="sd">			:type voxel_channels: int (required)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="o">==</span><span class="s2">&quot;regression&quot;</span><span class="p">):</span>
			<span class="n">final_layer_avt</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span>

		<span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="o">==</span><span class="s2">&quot;classification&quot;</span><span class="p">):</span>
			<span class="n">final_layer_avt</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span>

		<span class="k">def</span> <span class="nf">myloss</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
			<span class="n">prediction</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dimension</span><span class="p">]</span>
			<span class="n">log_variance</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dimension</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dimension</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">log_variance</span><span class="p">)</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_true</span> <span class="o">-</span> <span class="n">prediction</span><span class="p">))</span><span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">log_variance</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">loss</span>
		
		<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Conv3D</span><span class="p">,</span> <span class="n">MaxPool3D</span><span class="p">,</span> <span class="n">Flatten</span><span class="p">,</span> <span class="n">Dense</span>
		<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>

		<span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
		<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv3D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span><span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">voxel_dim</span><span class="p">,</span><span class="n">voxel_dim</span><span class="p">,</span><span class="n">voxel_dim</span><span class="p">,</span><span class="n">deviation_channels</span><span class="p">)))</span>
		<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv3D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
		<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv3D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
		<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPool3D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
		<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Flatten</span><span class="p">())</span>
		<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span><span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.02</span><span class="p">),</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
		<span class="c1">#model.add(Dropout(0.3))</span>
		<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dimension</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">final_layer_avt</span><span class="p">))</span>
		<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">myloss</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">])</span>

		<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;3D CNN model Aleatoric successfully compiled&quot;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">model</span></div>

<div class="viewcode-block" id="DLModel.cnn_model_3d_mdn"><a class="viewcode-back" href="../../../deep_learning.html#dlmfg.core.core_model.DLModel.cnn_model_3d_mdn">[docs]</a>	<span class="k">def</span> <span class="nf">cnn_model_3d_mdn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">voxel_dim</span><span class="p">,</span><span class="n">deviation_channels</span><span class="p">,</span><span class="n">num_of_mixtures</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Build the 3D Model with a Mixture Density Network output the gives parameters of a Gaussian Mixture Model as output, to be used if the system is expected to be collinear (Multi-Stage Assembly Systems) i.e. a single input can have multiple outputs</span>
<span class="sd">			Functions for predicting and sampling from a MDN.py need to used when deploying a MDN based model</span>
<span class="sd">			refer https://publications.aston.ac.uk/id/eprint/373/1/NCRG_94_004.pdf for more details on the working of a MDN model</span>
<span class="sd">			refer https://arxiv.org/pdf/1709.02249.pdf to understand how a MDN model can be leveraged to estimate the epistemic and aleatoric unceratninty present in manufacturing sytems based on the data collected</span>

<span class="sd">			:param voxel_dim: The voxel dimension of the input, reuired to build input to the 3D CNN model</span>
<span class="sd">			:type voxel_dim: int (required)</span>

<span class="sd">			:param voxel_channels: The number of voxel channels in the input structure, required to build input to the 3D CNN model</span>
<span class="sd">			:type voxel_channels: int (required)</span>

<span class="sd">			:param number_of_mixtures: The number of mixtures in the Gaussian Mixture Model output, defaults to 5, can be increased if higher collinearity is expected</span>
<span class="sd">			:type number_of_mixtures: int</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="o">==</span><span class="s2">&quot;regression&quot;</span><span class="p">,</span><span class="s2">&quot;Mixture Density Network Should be a Regression Model&quot;</span>
		
		<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Conv3D</span><span class="p">,</span> <span class="n">MaxPool3D</span><span class="p">,</span> <span class="n">Flatten</span><span class="p">,</span> <span class="n">Dense</span>
		<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>
		<span class="kn">import</span> <span class="nn">mdn</span>

		<span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
		<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv3D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span><span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">voxel_dim</span><span class="p">,</span><span class="n">voxel_dim</span><span class="p">,</span><span class="n">voxel_dim</span><span class="p">,</span><span class="n">deviation_channels</span><span class="p">)))</span>
		<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv3D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
		<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv3D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
		<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPool3D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
		<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Flatten</span><span class="p">())</span>
		<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span><span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.02</span><span class="p">),</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
		<span class="c1">#model.add(Dropout(0.3))</span>
		<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dimension</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">final_layer_avt</span><span class="p">))</span>
		<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">mdn</span><span class="o">.</span><span class="n">MDN</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dimension</span><span class="p">,</span> <span class="n">num_of_mixtures</span><span class="p">))</span>
		<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">mdn</span><span class="o">.</span><span class="n">get_mixture_loss_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dimension</span><span class="p">,</span><span class="n">num_of_mixtures</span><span class="p">),</span> <span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">)</span>

		<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;3D CNN Mixture Density Network model successfully compiled&quot;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">model</span></div></div>

<span class="k">if</span> <span class="p">(</span><span class="vm">__name__</span><span class="o">==</span><span class="s2">&quot;__main__&quot;</span><span class="p">):</span>
	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model Deep Learning Class&#39;</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Sumit Sinha

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>